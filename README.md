# MJPEG-VideoPlayer
Test task for Macroscop. Decoding MJPEG stream and render it with using of WPF

## Требования

Разработать приложение на .NET Framework (версия 4.5 или выше), позволяющее просматривать видео реального времени с одной из камер, подключенных к серверу видеонаблюдения.

Требование к приложению одно - не использовать готовые библиотеки и алгоритмы.

## Как пользоваться

**По состоянию на 12 марта 2018 приложение не работает так, как нужно по заданию. Пока я не знаю, как его добить.**

* Скомпилировать исполняемый файл MacroscopPlayer.exe
* В папке проекта лежат файлы MacroscopStreamOffice и MacroscopStreamRoad, хранящие 5-10 секунд видео в формате MJPEG. Они получены сохранением байтов видеопотока программой *Http Analyzer Std v7*. Нужно нажать *Save frames*, чтобы разбить файлы на кадры в формате JPEG. Кадры будут помещены в папку frames проекта.
* Нажать *Play*. На форме должны отображаться кадры. Скорость — 25 fps. Но отображается только последний, потому что я не знаю, как сделать работающую задержку между ними. Thread.Sleep(40) просто фризит окно.

---

Подробнее о том, как я работал над программой.

## Что я сделал 10 марта

1. Отправил HTTP-запрос на сервер, получил XML-документ. Из него достал айдишники камер.
2. Один из айди подставил в запрос видео из условия, вставил в браузер, начался скачиваться поток видео. Чтобы как-то его зафиксировать, включил запись в программе *HttpAnalyzerStdV7* и сохранил 11-секундный отрывок в виде файла.
3. Открыл в hex-редакторе. Понял, что jpeg всегда начинается с байтов FF D8 и заканчивается FF D9. Написал цикл, который каждое вхождение JPEG-рисунка в MJPEG-видео заливает в отдельный массив (на самом деле лист) байт. Сохранил все файлы в отдельной папке, пронумеровав.
4. Было сложно рендерить любой рисунок в окне. Оказалось, случайный тестовый пример, который я взял из гугла, был сломанный, и я долго провозился, хотя всё делал правильно. Ну сейчас вроде нормально.
Вот еще есть [ссылка](https://stackoverflow.com/questions/589173/rendering-an-image-at-runtime-in-wpf "Rendering an image at runtime in WPF") . Может, что-то пригодится завтра.
6. Понял, что нужно использовать потоки. Как? Не знаю.
7. Из 11-секундного куска потокового видео получается почти 300 кадров. Сохранил их в отдельной папке, потому что пока не научился работать с потоками, нет смысла держать их в байтах. 
![Набор фреймов](https://pp.userapi.com/c834200/v834200182/e4332/6GvKOtDFiw0.jpg "Набор фреймов") 

## Что я сделал 11 марта
1. Вынес рендер кадров в async. Не очень помогло, но хоть приложение теперь не виснет при отрисовке.
2. Почистил главное окно.
3. Убрал папки Views, Models и ViewModels, потому что не умею правильно работать, используя паттерн MVVM, а неправильно не хочу. Поправил настройки проекта.
4. Исправил функцию выделения ID камер из XML-документа и добавил ID и названия камер к элементам ComboBox'а.
